name: STAGE

on:
  push:
    branches: [ "stage" ]

env:
  REGISTRY: camilowu
  IMAGE_NAME: kubelabs_publicapi
  OPS_REPO: CamiloWu/Ops
  OPS_BRANCH: main

jobs:

  build:
    runs-on: ubuntu-latest

    steps:
      -uses: actions/checkout@v3 # checkout github code
       name: Checkout code
       with:
        fetch-depth: 0 # fetch tags
      
      -name: Login to Dockerhub
       uses: docker/login-action@v2
       with: 
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

      -name: Build and Push
       uses: docker/build-push-action@v3
       with:
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        build-args: |
          APP_ENV=${{ secrets.APP_ENV }}

      -name: Run test
       run: docker run --rm --name api -p 3000:3000 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
